name: Exofront ‚Äî build & deploy on VPS

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

concurrency:
  group: exofront-deploy-main
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Sync sources to VPS
        uses: burnett01/rsync-deployments@6.0.0
        with:
          switches: -az --delete
          path: .
          remote_path: /home/${{ secrets.VPS_USER }}/exofront-src
          remote_host: ${{ secrets.VPS_HOST }}
          remote_user: ${{ secrets.VPS_USER }}
          remote_key: ${{ secrets.VPS_SSH_KEY }}

      - name: Build image and rollout in K3s
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          envs: GITHUB_SHA
          command_timeout: 60m
          timeout: 60m
          script: |
            set -euo pipefail
            USER=${USER:-${{ secrets.VPS_USER }}}
            export CONTAINERD_ADDRESS=/run/k3s/containerd/containerd.sock
            cd ~/exofront-src
            TAG="${GITHUB_SHA}"

            echo "üß± Building exofront:${TAG}"
            sudo nerdctl --address "$CONTAINERD_ADDRESS" -n k8s.io build \
              --progress=plain \
              -t exofront:${TAG} \
              -t exofront:latest \
              .

            echo "üöÄ Applying manifests..."
            KUBECONFIG=/home/${USER}/.kube/config-exohunter kubectl -n exohunter apply \
              -f k8s/deploy.yaml -f k8s/service.yaml -f k8s/ingress.yaml

            echo "‚ôªÔ∏è Updating image..."
            KUBECONFIG=/home/${USER}/.kube/config-exohunter kubectl -n exohunter set image \
              deploy/exofront-deployment exofront=exofront:${TAG}

            echo "‚è≥ Rollout..."
            KUBECONFIG=/home/${USER}/.kube/config-exohunter kubectl -n exohunter rollout status \
              deploy/exofront-deployment --timeout=300s

            KUBECONFIG=/home/${USER}/.kube/config-exohunter kubectl -n exohunter get pods -o wide

<section class="explorer">
    <div class="explorer__bg"></div>
    <div class="explorer__glow"></div>

    <div class="explorer__content">
        <div class="explorer__eyebrow">
            <mat-icon>upload_file</mat-icon>
            ExoHunter Data Explorer
        </div>

        <h1 class="explorer__title">
            Upload Your Dataset
            <span class="explorer__title-fade">and Predict Exoplanets</span>
        </h1>

        <p class="explorer__subtitle">
            Upload a CSV file containing your light curve or exoplanet candidate data.
            The model will analyze it and return classification probabilities.
        </p>

        <mat-card class="explorer__card">
            <h3><mat-icon>description</mat-icon> Select File</h3>

            <div class="file-input">
                <input type="file" id="fileUpload" (change)="onFileSelected($event)" accept=".csv" hidden />
                <label for="fileUpload" class="btn-upload" mat-flat-button color="primary">
                    <mat-icon class="mat-icon-y">cloud_upload</mat-icon>
                    Choose CSV File
                </label>
                @if (fileName) {
                    <span>{{ fileName }}</span>
                }
            </div>

            @if (filePreview) {
            <div class="file-preview">
                <h4>Preview</h4>
                <table>
                    <tr>
                        <th *ngFor="let header of filePreview.headers">{{ header }}</th>
                    </tr>
                    <tr *ngFor="let row of filePreview.rows">
                        <td *ngFor="let cell of row">{{ cell }}</td>
                    </tr>
                </table>
            </div>
            }

            <div class="actions">
                <button mat-flat-button color="primary" (click)="predict()" [disabled]="!selectedFile || loading">
                    @if (loading) {
                        <mat-spinner diameter="20" class="inline-spinner"></mat-spinner>
                        Processing...
                    } @else {
                        <ng-container>
                            <mat-icon class="mat-icon-y">rocket_launch</mat-icon>
                            @if (backendData.length === 0) {
                              Run Prediction
                            } @else {
                              Re-run Prediction
                            }
                        </ng-container>
                    }
                </button>
            </div>

            @if (loading) {
            <div class="loading-section">
                <mat-spinner diameter="40"></mat-spinner>
                <p>Analyzing your data... This may take a few moments.</p>
            </div>
            }

            @if (uploadSuccess && backendData.length == 0) {
            <div class="prediction-result">
                @if (backendData.length === 0 && uploadSuccess) {
                <div class="no-data-message">
                    <mat-icon>warning</mat-icon>
                    <p>No data received from server. Please check your file format.</p>
                    <details style="margin-top: 1rem; text-align: left;">
                        <summary>Debug Info (click to expand)</summary>
                        <pre style="font-size: 0.8rem; color: #94a3d1; margin-top: 0.5rem;">
                      Prediction Result: {{ predictionResult }}
                      Backend Data Length: {{ backendData.length }}
                        </pre>
                    </details>
                </div>
                }
            </div>
            }

            @if (backendData.length > 0) {
            <div class="data-visualization">
                <div class="table-header-section">
                    <div class="table-title">
                        <mat-icon>table_view</mat-icon>
                        <h4>Prediction Results Table</h4>
                    </div>
                    <div class="table-actions">
                        <button mat-icon-button (click)="toggleSort()" [title]="getSortTitle()">
                            <mat-icon>{{ getSortIcon() }}</mat-icon>
                        </button>
                    </div>
                </div>

                <div class="table-info">
                    <p>Showing all {{ backendData.length }} results {{ getSortDescription() }}</p>
                    @if (backendData.length > 10000) {
                        <div class="performance-warning">
                            <mat-icon>info</mat-icon>
                            <span>Large dataset detected. Virtual scrolling is active for optimal performance.</span>
                        </div>
                    }
                </div>

                <div class="virtual-scroll-container">
                    <div class="table-header">
                        <div class="header-row">
                            <div class="header-cell clickable"
                                 *ngFor="let key of getDataColumns(); trackBy: trackByKey"
                                 (click)="sortByColumn(key)"
                                 [class.active]="sortColumn === key">
                                <span>{{ formatColumnName(key) }}</span>
                                <mat-icon *ngIf="sortColumn === key" class="sort-icon">
                                    {{ getSortIcon() }}
                                </mat-icon>
                            </div>
                        </div>
                    </div>

                    <cdk-virtual-scroll-viewport itemSize="50" class="viewport" minBufferPx="100" maxBufferPx="200">
                        <div class="data-row" *cdkVirtualFor="let item of backendData; trackBy: trackByIndex; templateCacheSize: 0">
                            <div class="data-cell" *ngFor="let key of dataColumns; trackBy: trackByKey"
                                 [attr.data-column]="key"
                                 [class.prediction-positive]="key === 'prediction' && item[key] === 1"
                                 [class.prediction-negative]="key === 'prediction' && item[key] === 0"
                                 [class.high-probability]="key === 'probability' && getNumericValue(item[key]) >= 90"
                                 [class.medium-probability]="key === 'probability' && getNumericValue(item[key]) >= 50 && getNumericValue(item[key]) < 90"
                                 [class.low-probability]="key === 'probability' && getNumericValue(item[key]) < 50">
                                {{ item[key] }}
                            </div>
                        </div>
                    </cdk-virtual-scroll-viewport>
                </div>
            </div>
            }
        </mat-card>
    </div>
</section>

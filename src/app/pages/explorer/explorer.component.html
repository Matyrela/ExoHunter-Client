<section class="explorer">
    <div class="explorer__bg"></div>

    <nav class="about__navbar" style="position: absolute; top: 24px; right: 32px; z-index: 10;">
      <button routerLink="/home" class="back-link" matTooltip="Back to Home">
        <mat-icon>home</mat-icon>
        Back to Home
      </button>
    </nav>

    <div class="explorer__content">
        <h1 class="explorer__title">
            Upload Your Dataset
            <span class="explorer__title-fade">and Predict Exoplanets</span>
        </h1>

        <p class="explorer__subtitle">
            Upload a CSV file containing your light curve or exoplanet candidate data.
            The model will analyze it and return classification probabilities.
        </p>

        <mat-card class="explorer__card">
            <div class="card-header">
                <h3><mat-icon>description</mat-icon> Select File</h3>
                <div class="example-downloads">
                    <span class="example-label">Example files:</span>
                    <div class="download-buttons">
                        <button mat-stroked-button class="example-btn" (click)="downloadExample('1000example.csv')">
                            <mat-icon>download</mat-icon>
                            1K rows
                        </button>
                        <button mat-stroked-button class="example-btn" (click)="downloadExample('5000example.csv')">
                            <mat-icon>download</mat-icon>
                            5K rows
                        </button>
                        <button mat-stroked-button class="example-btn" (click)="downloadExample('10000example.csv')">
                            <mat-icon>download</mat-icon>
                            10K rows
                        </button>
                    </div>
                </div>
            </div>

            <div class="file-input"
                 [class.drag-over]="isDragOver"
                 (dragover)="onDragOver($event)"
                 (dragleave)="onDragLeave($event)"
                 (drop)="onDrop($event)">
                <input type="file" id="fileUpload" (change)="onFileSelected($event)" accept=".csv" hidden />
                <div class="upload-area">
                    <label for="fileUpload" class="btn-upload" mat-flat-button color="primary">
                        <mat-icon class="mat-icon-y">cloud_upload</mat-icon>
                        Choose CSV File
                    </label>
                    <div class="drag-text">
                        <span>or drag and drop your CSV file here</span>
                    </div>
                    @if (fileName) {
                        <div class="selected-file">
                            <mat-icon>description</mat-icon>
                            <span>{{ fileName }}</span>
                        </div>
                    }
                </div>
            </div>

            <!-- CSV FORMAT INFO -->
            <div class="csv-info-section">
                <button mat-button class="info-toggle" (click)="showCsvInfo = !showCsvInfo">
                    <mat-icon>{{ showCsvInfo ? 'expand_less' : 'expand_more' }}</mat-icon>
                    What should my CSV contain?
                    <span class="info-badge">{{ csvColumns.length }} columns</span>
                </button>

                @if (showCsvInfo) {
                    <div class="csv-info-content">
                        <p class="info-description">
                            Your CSV file should contain exoplanet and stellar system data with the following columns.
                            All columns are expected but the model can handle some missing values:
                        </p>

                        <div class="columns-grid">
                            @for (column of csvColumns; track column.name) {
                                <div class="column-card" [attr.data-category]="column.category">
                                    <div class="column-header">
                                        <mat-icon>{{ column.icon }}</mat-icon>
                                        <span class="column-name">{{ column.name }}</span>
                                        <span class="column-category">{{ column.category }}</span>
                                    </div>
                                    <p class="column-description">{{ column.description }}</p>
                                    @if (column.units) {
                                        <span class="column-units">Units: {{ column.units }}</span>
                                    }
                                </div>
                            }
                        </div>

                        <div class="format-notes">
                            <div class="note-item">
                                <mat-icon>info</mat-icon>
                                <span>CSV files should use comma separators and include headers</span>
                            </div>
                            <div class="note-item">
                                <mat-icon>check_circle</mat-icon>
                                <span>Missing values are handled automatically by the model</span>
                            </div>
                            <div class="note-item">
                                <mat-icon>warning</mat-icon>
                                <span>Column names must match exactly (case sensitive)</span>
                            </div>
                        </div>
                    </div>
                }
            </div>

            @if (filePreview) {
            <div class="file-preview">
                <h4>Preview</h4>
                <table>
                    <tr>
                        <th *ngFor="let header of filePreview.headers">{{ header }}</th>
                    </tr>
                    <tr *ngFor="let row of filePreview.rows">
                        <td *ngFor="let cell of row">{{ cell }}</td>
                    </tr>
                </table>
            </div>
            }

            <div class="actions">
                <button mat-flat-button color="primary" (click)="predict()" [disabled]="!selectedFile || loading">
                    @if (loading) {
                        <mat-spinner diameter="20" class="inline-spinner"></mat-spinner>
                        Processing...
                    } @else {
                        <ng-container>
                            <mat-icon class="mat-icon-y">rocket_launch</mat-icon>
                            @if (backendData.length === 0) {
                              Run Prediction
                            } @else {
                              Re-run Prediction
                            }
                        </ng-container>
                    }
                </button>
            </div>

            @if (loading) {
            <div class="loading-section">
              <div>
                <mat-spinner diameter="40"></mat-spinner>
              </div>
              <p>Analyzing your data... This may take a few moments.</p>
            </div>
            }

            @if (uploadSuccess && backendData.length == 0) {
            <div class="prediction-result">
                @if (backendData.length === 0 && uploadSuccess) {
                <div class="no-data-message">
                    <mat-icon>warning</mat-icon>
                    <p>No data received from server. Please check your file format.</p>
                    <details style="margin-top: 1rem; text-align: left;">
                        <summary>Debug Info (click to expand)</summary>
                        <pre style="font-size: 0.8rem; color: #94a3d1; margin-top: 0.5rem;">
                      Prediction Result: {{ predictionResult }}
                      Backend Data Length: {{ backendData.length }}
                        </pre>
                    </details>
                </div>
                }
            </div>
            }

            @if (serverError) {
              <div class="server-error-message">
                  <mat-icon>error</mat-icon>
                  <h4>Server Error</h4>
                  <p>There was an error processing your request on the server. Please try again later or contact support if the problem persists.</p>
                  <div class="error-details">
                      <p><strong>Error:</strong> {{ predictionResult }}</p>
                  </div>
                  <button mat-flat-button color="warn" (click)="predict()" [disabled]="!selectedFile">
                      <mat-icon>refresh</mat-icon>
                      Try Again
                  </button>
              </div>
            }

            @if (backendData.length > 0) {
            <div class="data-visualization">
                <div class="table-header-section">
                    <div class="table-title">
                        <mat-icon>table_view</mat-icon>
                        <h4>Prediction Results Table</h4>
                    </div>
                </div>

                <div class="table-actions">
                    <div class="search-container">
                        <mat-form-field appearance="outline">
                            <mat-label>Search</mat-label>
                            <input matInput [(ngModel)]="searchTerm" (input)="onSearch()" placeholder="Type to search..." />
                            <button mat-icon-button matSuffix *ngIf="searchTerm" (click)="searchTerm = ''; onSearch()">
                                <mat-icon>close</mat-icon>
                            </button>
                        </mat-form-field>
                    </div>

                    <div class="threshold-container">
                        <label for="threshold-slider">Prediction Threshold: {{ predictionThreshold }}%</label>
                        <mat-slider min="0" max="100" step="1" discrete>
                            <input matSliderThumb [value]="predictionThreshold" (valueChange)="onThresholdChange($event)">
                        </mat-slider>
                    </div>

                    <div class="download-container">
                        <button mat-flat-button class="download-btn" (click)="downloadProcessedData()"
                                matTooltip="Download current results as CSV">
                            <mat-icon>file_download</mat-icon>
                            Download CSV
                        </button>
                    </div>
                </div>

                <div class="virtual-scroll-container">
                    <div class="table-header">
                        <div class="header-row">
                            <div class="header-cell clickable"
                                 *ngFor="let key of getDataColumns(); trackBy: trackByKey"
                                 (click)="sortByColumn(key)"
                                 [class.active]="sortColumn === key">
                                <span>{{ formatColumnName(key) }}</span>
                                <mat-icon *ngIf="sortColumn === key" class="sort-icon">
                                    {{ getSortIcon() }}
                                </mat-icon>
                            </div>
                        </div>
                    </div>

                    <cdk-virtual-scroll-viewport itemSize="50" class="viewport" minBufferPx="100" maxBufferPx="200">
                        <div class="data-row" *cdkVirtualFor="let item of displayData; trackBy: trackByIndex; templateCacheSize: 0">
                            <div class="data-cell" *ngFor="let key of dataColumns; trackBy: trackByKey"
                                 [attr.data-column]="key"
                                 [class.prediction-positive]="key === 'prediction' && item[key] === 1"
                                 [class.prediction-negative]="key === 'prediction' && item[key] === 0"
                                 [ngClass]="key === 'probability' ? getProbabilityClass(item[key]) : ''">
                                @if (key === 'prediction') {
                                    {{ getPredictionIcon(item[key]) }}
                                } @else {
                                    {{ item[key] }}
                                }
                            </div>
                        </div>
                    </cdk-virtual-scroll-viewport>
                </div>

                <br>

                <div class="table-info">
                    <p>
                        @if (searchTerm.trim()) {
                            Showing {{ displayData.length }} of {{ originalData.length }} results (filtered) {{ getSortDescription() }}
                        } @else {
                            Showing all {{ displayData.length }} results {{ getSortDescription() }}
                        }
                    </p>
                    @if (originalData.length > 10000) {
                        <div class="performance-warning">
                            <mat-icon>info</mat-icon>
                            <span>Large dataset detected. Virtual scrolling is active for optimal performance.</span>
                        </div>
                    }
                </div>
            </div>
            }
        </mat-card>
    </div>
</section>
